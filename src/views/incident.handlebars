<section class="incident-header">
    <div class="incident-header-top">
        <a href="/feed?zip={{zip}}&page={{page}}" class="back-link">‚Üê Back to Feed</a>
    </div>
    <h1>{{incident.complaintType}}</h1>
</section>

<section class="incident-details-card">
    <div class="incident-detail-grid">
        {{#if incident.descriptor}}
        <div class="detail-item">
            <span class="detail-label">Description:</span>
            <span class="detail-value">{{incident.descriptor}}</span>
        </div>
        {{/if}}

        <div class="detail-item">
            <span class="detail-label">Status:</span>
            <span class="detail-value status-badge status-{{incident.status}}">{{incident.status}}</span>
        </div>

        {{#if incident.agency}}
        <div class="detail-item">
            <span class="detail-label">Agency:</span>
            <span class="detail-value">{{incident.agency}}</span>
        </div>
        {{/if}}

        {{#if incident.incidentZip}}
        <div class="detail-item">
            <span class="detail-label">ZIP Code:</span>
            <span class="detail-value">{{incident.incidentZip}}</span>
        </div>
        {{/if}}

        {{#if incident.createdDate}}
        <div class="detail-item">
            <span class="detail-label">Created:</span>
            <span class="detail-value">{{incident.createdDate}}</span>
        </div>
        {{/if}}
    </div>
</section>

{{#if incident.latitude}}
{{#if incident.longitude}}
<section class="incident-map-section">
    <h3>Location</h3>
    <div id="map" data-lat="{{incident.latitude}}" data-lng="{{incident.longitude}}"
        data-complaint="{{incident.complaintType}}" data-desc="{{incident.descriptor}}" class="incident-map">
    </div>
</section>
{{else}}
<section class="incident-map-section">
    <h3>Location</h3>
    <p class="no-location">No location data available.</p>
</section>
{{/if}}
{{else}}
<section class="incident-map-section">
    <h3>Location</h3>
    <p class="no-location">No location data available.</p>
</section>
{{/if}}

<section class="comments-section">
    <h3>Comments</h3>

    {{#if user}}
    {{#if error}}
    <p class="error comment-error" role="alert" aria-live="polite">{{error}}</p>
    {{/if}}
    <form class="comment-form" action="/incident/{{incident.openDataId}}/comment" method="POST">
        <input type="hidden" name="zip" value="{{zip}}">
        <input type="hidden" name="page" value="{{page}}">
        <label for="comment-content" class="sr-only">Comment</label>
        <textarea name="content" id="comment-content" rows="3" placeholder="Write a comment..." required maxlength="500" minlength="1" aria-describedby="char-count" aria-required="true"></textarea>
        <small class="char-count" id="char-count" aria-live="polite">0/500 characters</small>
        <button type="submit" class="btn" aria-label="Post your comment">Post Comment</button>
    </form>
    {{else}}
    <p class="login-prompt"><a href="/auth/login">Login</a> to post a comment.</p>
    {{/if}}

    {{#if comments.length}}
    <ul class="comment-list">
        {{#each comments}}
        <li class="comment-item" id="comment-{{this._id}}" data-user-id="{{../user.id}}">
            <div class="comment-header">
                <strong class="comment-author">{{this.username}}</strong>
                <small class="comment-date">{{this.createdAt}}</small>
            </div>
            <div class="comment-content">
                {{this.content}}
            </div>
            <div class="comment-actions">
                <button class="vote-btn vote-btn-like" id="likeButton-{{this._id}}" data-comment-id="{{this._id}}" data-type="like" data-incident-id="{{../incident.openDataId}}">
                    <span class="vote-icon">üëç</span>
                    <span class="vote-count" id="likeCount-{{this._id}}">{{#if this.likes}}{{this.likes.length}}{{else}}0{{/if}}</span>
                </button>
                <button class="vote-btn vote-btn-dislike" id="dislikeButton-{{this._id}}" data-comment-id="{{this._id}}" data-type="dislike" data-incident-id="{{../incident.openDataId}}">
                    <span class="vote-icon">üëé</span>
                    <span class="vote-count" id="dislikeCount-{{this._id}}">{{#if this.dislikes}}{{this.dislikes.length}}{{else}}0{{/if}}</span>
                </button>
            </div>
        </li>
        {{/each}}
    </ul>
    {{else}}
    <p class="no-comments">No comments yet. Be the first to comment!</p>
    {{/if}}
</section>
<script src="/public/js/incidentMap.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/public/js/comments.js"></script>
<script src="/public/js/commentForm.js"></script>