<section>
  {{#if user}}
  <h1>Welcome back, {{user.username}}!</h1>
  <p>Your account is set. Next up: incidents, comments, votes, and trends.</p>
  {{else}}
  <h1>Welcome</h1>
  <p>Sign in to get started.</p>
  <p><a href="/auth/login">Login</a> or <a href="/auth/register">Create an account</a>.</p>
  {{/if}}
</section>

<hr />

<section>
  <h2>Search 311 Incidents by ZIP</h2>

  <form action="/feed" method="POST" class="zip-form">
    <label for="zip">Enter ZIP Code:</label>
    <input type="text" id="zip" name="zip" value="{{zip}}" placeholder="e.g., 10001" required />

    <button type="submit">Search</button>

    {{#if error}}
    <p class="error">{{error}}</p>
    {{/if}}
  </form>
</section>

{{#if zip}}
<hr />
<div class="feed-layout">
  <aside class="sidebar-filters">
    <section class="quick-filters">
      <h3>Quick Filters</h3>
      <form action="/feed" method="GET">
        <input type="hidden" name="zip" value="{{zip}}">
        <input type="hidden" name="page" value="1">
        
        <div class="api-option">
          <label class="api-toggle">
            <input type="checkbox" name="useAPI" value="true" {{#if useAPI}}checked{{/if}}>
            <span class="checkbox-custom"></span>
            <span class="api-label">
              <strong>Query API directly</strong>
              <small>Get latest data without caching</small>
            </span>
          </label>
        </div>

        <label>
          Status:
          <select name="status">
            <option value="">All</option>
            <option value="Open" {{#if (eq status "Open" )}}selected{{/if}}>Open</option>
            <option value="Closed" {{#if (eq status "Closed" )}}selected{{/if}}>Closed</option>
          </select>
        </label>

        <label>
          Complaint Type:
          <input type="text" name="complaintType" placeholder="e.g. Noise" value="{{complaintType}}">
        </label>

        <label>
          Agency:
          <input type="text" name="agency" placeholder="e.g. NYPD" value="{{agency}}">
        </label>

        <label>
          Sort By:
          <select name="sort">
            <option value="">Newest</option>
            <option value="oldest" {{#if (eq sort "oldest" )}}selected{{/if}}>
              Oldest
            </option>
          </select>
        </label>

        {{#if useAPI}}
        <input type="hidden" name="useAPI" value="true">
        {{/if}}

        <button type="submit" class="btn">Apply Filters</button>
      </form>
    </section>
  </aside>

  <main class="feed-content">
    <section>
      <h2>Recent Incidents for ZIP {{zip}}</h2>

      {{#if autoFetched}}
      <div class="auto-fetch-notice">
        <span class="notice-icon">âœ“</span>
        <span>Automatically fetched latest data from NYC 311 API</span>
      </div>
      {{/if}}

      {{#if incidents.length}}
  <ul class="incident-list">
    {{#each incidents}}
    <li class="incident-item">
      <strong>{{this.complaintType}}</strong><br />
      {{this.descriptor}}<br />
      <em>{{this.createdDate}}</em><br />
      Status: {{this.status}}<br />

      <a href="/incident/{{this.openDataId}}?zip={{../zip}}&page={{../page}}">View Details</a>
    </li>
    {{/each}}
  </ul>

  {{!-- page --}}
  <div class="pagination">
    {{#if page}}

    {{#if (gt page 1)}}
    <form action="/feed" method="GET" style="display:inline;">
      <input type="hidden" name="zip" value="{{zip}}">
      <input type="hidden" name="page" value="{{decrement page}}">
      <input type="hidden" name="status" value="{{status}}">
      <input type="hidden" name="complaintType" value="{{complaintType}}">
      <input type="hidden" name="agency" value="{{agency}}">
      <input type="hidden" name="sort" value="{{sort}}">
      {{#if useAPI}}
      <input type="hidden" name="useAPI" value="true">
      {{/if}}
      <button type="submit">Previous</button>
    </form>
    {{/if}}

    <span>Page {{page}}</span>

    {{#if hasNextPage}}
    <form action="/feed" method="GET" style="display:inline;">
      <input type="hidden" name="zip" value="{{zip}}">
      <input type="hidden" name="page" value="{{increment page}}">
      <input type="hidden" name="status" value="{{status}}">
      <input type="hidden" name="complaintType" value="{{complaintType}}">
      <input type="hidden" name="agency" value="{{agency}}">
      <input type="hidden" name="sort" value="{{sort}}">
      {{#if useAPI}}
      <input type="hidden" name="useAPI" value="true">
      {{/if}}
      <button type="submit">Next</button>
    </form>
    {{/if}}

      {{/if}}
      </div>

      {{else}}
      <div class="no-results">
        <p><strong>No incidents found for ZIP {{zip}}</strong></p>
        <p>This ZIP code may not have any recent 311 service requests. Try:</p>
        <ul>
          <li>Searching a different ZIP code</li>
          <li>Checking if the ZIP code is correct</li>
          <li>Using "Query API directly" option to get the latest data</li>
        </ul>
      </div>
      {{/if}}
    </section>
  </main>
</div>
{{/if}}